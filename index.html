<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>FIN-JOD ¬∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‚Äì‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô + ‡∏´‡∏ô‡∏µ‡πâ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{ box-sizing:border-box }
    :root{
      --bg:#1e1e1e; --bg2:#242424; --panel:#2a2a2a; --line:#3a3a3a; --muted:#bfbfbf; --text:#f1f1f1;
      --primary:#ff2e80; --primary-2:#e91e63; --blue:#6c8cff; --green:#00c896; --danger:#ff4d4f; --warning:#ffb020; --cyan:#2dd4bf;
    }
    html,body{ height:100% }
    body{
      margin:0; padding:clamp(0.75rem,2vw,2rem);
      padding-bottom:calc(clamp(0.75rem,2vw,2rem) + env(safe-area-inset-bottom,0px));
      font-family:'Kanit',sans-serif; background:var(--bg); color:var(--text)
    }
    h1{ text-align:center; font-size:clamp(1.25rem,4.5vw,2rem); color:var(--primary); margin:0 0 1rem }
    .container{ width:min(1140px,100%); margin:auto; background:var(--panel); padding:clamp(0.75rem,2.5vw,2rem);
      border-radius:24px; box-shadow:0 12px 30px rgba(0,0,0,.5) }

    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap; margin:0 0 1rem }
    .tabbtn{ padding:.8rem 1.1rem; border-radius:12px; border:1px solid #444; background:#1f1f1f; color:#ddd; cursor:pointer; min-height:44px; touch-action:manipulation }
    .tabbtn.active{ background:var(--primary); border-color:var(--primary); color:#fff; font-weight:700 }
    .section{ display:none } .section.active{ display:block }

    .row{ display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; align-items:flex-start }
    .col{ flex:1 1 46%; display:flex; flex-direction:column; gap:.4rem; min-width:220px }
    label{ color:var(--muted); font-size:.95rem }
    input,select,button{ padding:1rem 1.1rem; font-size:16px; border-radius:12px; border:1px solid #555; background:#1e1e1e; color:#fff; min-height:44px }
    input[type=number]{ text-align:right; -moz-appearance:textfield }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    button{ background:var(--primary); border:none; font-weight:700; cursor:pointer; transition:background .2s; touch-action:manipulation }
    @media (hover:hover) and (pointer:fine){ button:hover{ background:var(--primary-2) } }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .btn-ghost{ background:#3a3a3a } .btn-green{ background:var(--green) } .btn-blue{ background:var(--blue) } .btn-danger{ background:var(--danger) } .btn-cyan{ background:var(--cyan); color:#052a27 }

    .card{ background:var(--bg2); border:1px solid var(--line); border-radius:18px; padding:1.25rem }
    .muted{ color:var(--muted) } .right{ text-align:right }
    .chart-wrap{ height:260px; width:100% } .chart-wrap canvas{ width:100% !important; height:100% !important; display:block }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:.98rem }
    th,td{ border-bottom:1px solid var(--line); padding:.8rem .5rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    th{ color:var(--muted); font-weight:600; text-align:left; position:sticky; top:0; background:var(--bg2); z-index:1 }
    .table-viewport{ max-height:420px; overflow:auto; border-radius:12px; border:1px solid var(--line) }
    .table-viewport tbody tr:hover{ background:#2f2f2f }
    .badge{ padding:.25rem .5rem; border-radius:999px; font-size:.85rem }
    .badge-inc{ background:rgba(0,200,150,.18); color:#9ff3df; border:1px solid rgba(0,200,150,.35) }
    .badge-exp{ background:rgba(233,30,99,.15); color:#ffb6cc; border:1px solid rgba(233,30,99,.35) }
    .badge-sav{ background:rgba(45,212,191,.16); color:#a7fff0; border:1px solid rgba(45,212,191,.35) }
    .badge-debt{ background:rgba(108,140,255,.16); color:#c8d2ff; border:1px solid rgba(108,140,255,.35) }

    #toast{ position:fixed; left:50%; bottom:calc(22px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%);
      background:#333; color:#fff; padding:.75rem 1.2rem; border-radius:12px; opacity:0; transition:.35s; pointer-events:none; z-index:100 }
    .hide{ display:none }
    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:99 }
    #overlay.show{ display:flex }
    .spinner{ width:58px; height:58px; border:6px solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .skeleton{ position:relative; overflow:hidden; background:#2b2b2b; border-radius:8px; min-height:20px }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent); animation:skeleton 1.2s infinite }
    @keyframes skeleton{ 100%{ transform:translateX(100%) } }

    .inline-status{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin:.25rem 0 .5rem }
    .inline-status .sep{ opacity:.55 }
    .bar-track{ height:10px; background:#3a3a3a; border-radius:999px; overflow:hidden }
    .bar-fill{ height:100%; width:0% }
    #budgetBar{ background:linear-gradient(90deg,#6c8cff,#ffb020,#ff4d4f) }
    #savingBar{ background:linear-gradient(90deg,#2dd4bf,#00c896) }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:60 }
    .modal-backdrop.show{ display:flex }
    .modal{ width:min(640px,96vw); background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:1rem 1rem 1.25rem; box-shadow:0 20px 60px rgba(0,0,0,.6) }
    .modal .title{ font-weight:700; margin-bottom:.75rem }
    .modal .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem }
    .segbtn{ background:#3a3a3a } .segbtn.active{ background:var(--primary); color:#fff; font-weight:700 }

    .kpi{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1rem; }
    .kpi .card{ display:flex; flex-direction:column; gap:.35rem; min-height:92px }

    @media(max-width:980px){ .chart-wrap{ height:220px } }
    @media(max-width:768px){
      .col{ flex:1 1 100% } .chart-wrap{ height:200px }
      .table-viewport{ max-height:none; overflow-y:visible; overflow-x:auto; -webkit-overflow-scrolling:touch; }
      th{ position:static } table{ min-width:720px; table-layout:auto }
    }

    #tblDebts td:last-child { overflow: visible; }
    #tblDebts td:last-child .actions { display:flex; gap:.5rem; }

    #pop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:130; background:transparent }
    #pop.show{ display:flex; }
    .pop-box{ display:flex; align-items:center; gap:.6rem; background:var(--panel); border:1px solid rgba(0,200,150,.35); border-radius:14px; padding:.9rem 1.1rem; box-shadow:0 16px 40px rgba(0,0,0,.55) }
    .pop-icon{ width:26px; height:26px; border-radius:50%; background:var(--green); color:#052a27; font-weight:900; display:flex; align-items:center; justify-content:center }
    .pop-msg{ font-weight:700 }
  </style>
</head>
<body>
  <div class="container">
    <h1>FIN-JOD ¬∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‚Äì‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô + ‡∏´‡∏ô‡∏µ‡πâ</h1>

    <div id="loginBox" class="card">
      <div class="row">
        <div class="col">
          <label for="inpUser">User ID</label>
          <input id="inpUser" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" autocomplete="username"/>
        </div>
        <div class="col">
          <label for="inpPin">PIN</label>
          <input id="inpPin" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" autocomplete="current-password"/>
        </div>
      </div>
      <div class="row">
        <button id="btnLogin" class="btn-green">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <span id="loginMsg" class="muted" style="align-self:center"></span>
      </div>
      <div class="muted" style="margin-top:.25rem">* ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö User ID ‡πÅ‡∏•‡∏∞ Password</div>
    </div>

    <div id="app" class="hide">
      <div class="row" style="align-items:center; margin-top:.5rem">
        <div class="muted">üë§ <span id="who"></span></div>
        <div style="margin-left:auto">
          <button id="btnLogout" class="btn-ghost">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å">
        <button class="tabbtn active" role="tab" aria-selected="true" aria-controls="tab-add"    data-tab="add">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="tabbtn"        role="tab" aria-selected="false" aria-controls="tab-debt"  data-tab="debt">‡∏´‡∏ô‡∏µ‡πâ</button>
        <button class="tabbtn"        role="tab" aria-selected="false" aria-controls="tab-dash"  data-tab="dash">Dashboard</button>
        <button class="tabbtn"        role="tab" aria-selected="false" aria-controls="tab-list"  data-tab="list">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <section id="tab-add" class="section active card" tabindex="-1">
        <div class="row">
          <div class="col">
            <label for="txDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="txDate" type="date" />
          </div>
          <div class="col">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <div class="row" style="gap:.5rem; margin:0; flex-wrap:wrap">
              <button id="btnTypeExp" class="btn-ghost" aria-pressed="true">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
              <button id="btnTypeInc" class="btn-ghost" aria-pressed="false">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
              <button id="btnTypeSav" class="btn-ghost" aria-pressed="false">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
              <span class="muted" style="align-self:center">|</span>
              <button id="btnTypeDebtRepay"  class="btn-ghost" aria-pressed="false" title="‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ">‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</button>
              <button id="btnTypeDebtBorrow" class="btn-ghost" aria-pressed="false" title="‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ">‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ</button>
            </div>
            <select id="txType" class="hide" aria-hidden="true">
              <option value="expense" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
              <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
              <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
              <option value="debt_repay">‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</option>
              <option value="debt_borrow">‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ</option>
            </select>
          </div>
          <div class="col" id="colCat">
            <label for="txCat">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <select id="txCat"></select>
            <div class="row" style="gap:.5rem; margin:.5rem 0 0">
              <button id="btnAddCatInline" class="btn-blue" style="min-width:140px">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
            </div>
            <div class="muted" style="font-size:.9rem">* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>
          </div>
          <div class="col hide" id="colDebt">
            <label for="txDebt">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label>
            <select id="txDebt"></select>
            <div class="muted" style="font-size:.9rem">* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡∏´‡∏ô‡∏µ‡πâ‚Äù</div>
          </div>
          <div class="col hide" id="colDebtRepayFields">
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</label>
            <div class="row" style="gap:.5rem; margin:0">
              <div class="col"><input id="txInt" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)"></div>
              <div class="col"><input id="txPrin" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)"></div>
            </div>
            <div class="muted" style="font-size:.9rem">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° = ‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å + ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô</div>
          </div>
          <div class="col" id="colAmount">
            <label for="txAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input id="txAmount" type="number" step="0.01" placeholder="0.00" inputmode="decimal">
          </div>
        </div>
        <div class="row save-row" style="align-items:flex-end; gap:1rem">
          <div class="col" style="flex:1 1 0">
            <label for="txNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <input id="txNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" maxlength="500">
          </div>
          <div class="col" style="flex:0 0 auto">
            <button id="btnSave" class="btn-green" style="min-width:180px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
        </div>
        <div class="card quickadd hide" style="margin-top: 1rem;">
          <div class="muted" style="margin-bottom:.5rem">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô</div>
          <div class="quick-wrap" id="quickWrap"></div>
          <div class="row" style="margin-top:.5rem">
            <div class="col"><input id="qaLabel" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡πÅ‡∏ü" /></div>
            <div class="col">
              <select id="qaType">
                <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
              </select>
            </div>
            <div class="col"><input id="qaAmount" type="number" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" /></div>
            <div class="col"><button class="btn-blue" id="btnAddQA">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Quick Add</button></div>
          </div>
        </div>
      </section>

      <section id="tab-debt" class="section card" tabindex="-1">
        <div class="card" style="margin-bottom:1rem">
          <div class="muted" style="margin-bottom:.5rem">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</div>
          <div class="row">
            <div class="col"><label for="dName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label><input id="dName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£ X / ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô A"></div>
            <div class="col"><label for="dRate">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)</label><input id="dRate" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 18"></div>
            <div class="col"><label for="dPrincipal">‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><input id="dPrincipal" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10000"></div>
            <div class="col" style="align-self:flex-end"><button id="btnAddDebt" class="btn-blue">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</button></div>
          </div>
        </div>
        <div class="card hide" style="margin-bottom:1rem">
          <div class="muted" style="margin-bottom:.5rem">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏î‡πà‡∏ß‡∏ô</div>
          <div class="row">
            <div class="col"><label for="dqType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <select id="dqType">
                <option value="repay">‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</option>
                <option value="borrow">‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ</option>
              </select>
            </div>
            <div class="col"><label for="dqDebt">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label><select id="dqDebt"></select></div>
            <div class="col"><label for="dqDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="dqDate" type="date"></div>
            <div class="col" id="dqColRepay1"><label for="dqInt">‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)</label><input id="dqInt" type="number" step="0.01" placeholder="0.00"></div>
            <div class="col" id="dqColRepay2"><label for="dqPrin">‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="dqPrin" type="number" step="0.01" placeholder="0.00"></div>
            <div class="col hide" id="dqColAmount"><label for="dqAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="dqAmount" type="number" step="0.01" placeholder="0.00"></div>
            <div class="col" style="flex:1 1 100%"><label for="dqNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="dqNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></div>
            <div class="col" style="align-self:flex-end"><button id="btnDebtQuick" class="btn-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1rem">
          <div class="muted" style="margin-bottom:.5rem">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)</div>
          <div class="table-viewport">
            <table>
              <thead>
                <tr>
                  <th style="width:200px">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</th>
                  <th style="width:110px" class="right">% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</th>
                  <th style="width:140px" class="right">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th>
                  <th style="width:140px" class="right">‡∏î‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á</th>
                  <th style="width:140px" class="right">‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</th>
                  <th style="width:130px">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ñ‡∏∂‡∏á</th>
                  <th style="width:200px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="tblDebts"></tbody>
            </table>
          </div>
          <div class="muted" style="margin-top:.5rem">* ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÉ‡∏ô ‚Äú‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
        </div>
        <div class="card hide">
          <div class="row" style="margin-bottom:.25rem">
            <div class="col"><label for="dtFrom">‡∏à‡∏≤‡∏Å</label><input id="dtFrom" type="date"></div>
            <div class="col"><label for="dtTo">‡∏ñ‡∏∂‡∏á</label><input id="dtTo" type="date"></div>
            <div class="col"><label for="dtDebt">‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label><select id="dtDebt"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
            <div class="col" style="align-self:flex-end"><button id="btnLoadDebtTx" class="btn-blue">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></div>
          </div>
          <div class="table-viewport">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="width:120px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</th>
                  <th class="right" style="width:120px">‡∏¢‡∏≠‡∏î</th>
                  <th class="right" style="width:120px">‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å</th>
                  <th class="right" style="width:120px">‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô</th>
                  <th class="right" style="width:110px">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô</th>
                  <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="tblDebtTx"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="tab-dash" class="section card" tabindex="-1">
        <div class="row">
          <div class="col"><label for="fFrom">‡∏à‡∏≤‡∏Å</label><input id="fFrom" type="date"></div>
          <div class="col"><label for="fTo">‡∏ñ‡∏∂‡∏á</label><input id="fTo" type="date"></div>
          <div class="col">
            <label>&nbsp;</label>
            <div class="row" style="gap:.5rem; margin:0">
              <button class="segbtn" id="btnToday">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
              <button class="segbtn" id="btn7">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
              <button class="segbtn" id="btn30">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
              <button class="segbtn" id="btnMonth">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
              <button class="segbtn" id="btnYear">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
              <button class="btn-blue"  id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div style="margin-top:.5rem"><span class="badge badge-debt">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π: <span id="rangeBadge">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span></span></div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1rem">
          <div class="row">
            <div class="col">
              <label for="budgetThisMonth">‡∏á‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label>
              <input id="budgetThisMonth" type="number" min="0" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10000">
            </div>
            <div class="col">
              <label for="savingGoalThisMonth">‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó)</label>
              <input id="savingGoalThisMonth" type="number" min="0" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1500">
            </div>
            <div class="col" style="align-self:flex-end"><button id="btnSaveBudget" class="btn-blue">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö/‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≠‡∏°</button></div>
          </div>
          <div class="inline-status muted">
            <span>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: <b id="budgetUsedPct">‚Äî</b></span><span class="sep">|</span><span id="budgetStatus">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‚Äî</span>
          </div>
          <div class="bar-track"><div id="budgetBar" class="bar-fill"></div></div>
          <div class="inline-status muted" style="margin-top:.6rem">
            <span>‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß: <b id="savingGoalPct">‚Äî</b></span><span class="sep">|</span><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b id="savingGoalStatus">‚Äî</b></span>
          </div>
          <div class="bar-track"><div id="savingBar" class="bar-fill"></div></div>
        </div>
        <div class="kpi" id="kpiWrap">
          <div class="card"><div class="muted">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div><div id="sumIncome"  style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
          <div class="card"><div class="muted">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div><div id="sumExpense" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
          <div class="card"><div class="muted">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</div><div id="sumSaving" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
          <div class="card" id="netCard"><div class="muted">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)</div><div id="sumNet"     style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
          <div class="card"><div class="muted">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div><div id="sumDebt" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
        </div>
        <div class="row">
          <div class="card" style="flex:1 1 48%">
            <div class="muted" style="margin-bottom:.5rem">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</div>
            <div id="noDataExp" class="muted hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
            <div class="chart-wrap"><canvas id="chartExp"></canvas></div>
          </div>
          <div class="card" style="flex:1 1 48%">
            <div class="muted" style="margin-bottom:.5rem">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô & ‡∏™‡∏∞‡∏™‡∏°)</div>
            <div id="noDataFlow" class="muted hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
            <div class="chart-wrap"><canvas id="chartFlow"></canvas></div>
          </div>
        </div>
        <div class="row">
          <div class="card" style="flex:1 1 48%">
            <div class="muted" style="margin-bottom:.5rem">‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏° (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</div>
            <div id="noDataDebtTS" class="muted hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
            <div class="chart-wrap"><canvas id="chartDebtTS"></canvas></div>
          </div>
          <div class="card" style="flex:1 1 48%">
            <div class="muted" style="margin-bottom:.5rem">‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô vs ‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
            <div id="noDataPI" class="muted hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
            <div class="chart-wrap"><canvas id="chartPI"></canvas></div>
          </div>
        </div>
        <div class="row">
          <div class="card" style="flex:1 1 100%">
            <div class="muted" style="margin-bottom:.5rem">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∞‡∏™‡∏° (‡∏ù‡∏≤‡∏Å ‚àí ‡∏ñ‡∏≠‡∏ô)</div>
            <div id="noDataSav" class="muted hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
            <div class="chart-wrap"><canvas id="chartSavCum"></canvas></div>
          </div>
        </div>
      </section>

      <section id="tab-list" class="section card" tabindex="-1">
        <div class="muted" style="margin-bottom:.5rem">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏à‡∏≤‡∏Å‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î)</div>
        <div class="table-viewport">
          <table>
            <thead><tr>
              <th style="width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th style="width:160px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏´‡∏°‡∏ß‡∏î</th>
              <th class="right" style="width:130px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
              <th style="width:92px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
        <div id="emptyList" class="muted" style="margin-top:.5rem; display:none">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      </section>
    </div>
  </div>

  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div id="editTitle" class="title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      <input id="editTxId" type="hidden">
      <div class="row">
        <div class="col"><label for="editDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="editDate" type="date"></div>
        
        <div class="col" id="editColType">
          <label for="editType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="editType">
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
            <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
        </div>
        <div class="col" id="editColCat">
          <label for="editCat">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <select id="editCat"></select>
        </div>
        
        <div class="col" id="editColAmount">
            <label for="editAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input id="editAmount" type="number" step="0.01" placeholder="0.00">
        </div>

        <div class="col hide" id="editColDebtRepayFields" style="flex:1 1 100%">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</label>
          <div class="row" style="gap:.5rem; margin:0">
            <div class="col"><input id="editInt" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)"></div>
            <div class="col"><input id="editPrin" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)"></div>
          </div>
        </div>
        
        <div class="col" style="flex:1 1 100%"><label for="editNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="editNote" maxlength="500" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></div>
      </div>
      <div class="actions">
        <button id="btnDelete" class="btn-danger">‡∏•‡∏ö</button>
        <button id="btnCancel" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnUpdate" class="btn-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>

  <div id="confirmBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div id="confirmTitle" class="title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
      <div id="confirmMsg" class="muted" style="margin-bottom:.75rem">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</div>
      <div class="actions">
        <button id="btnNo" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnYes" class="btn-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <div id="addCatBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addCatTitle">
      <div id="addCatTitle" class="title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</div>
      <div class="row">
        <div class="col"><label for="addCatType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="addCatType">
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
            <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
        </div>
        <div class="col" style="flex:1 1 100%"><label for="addCatName">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</label><input id="addCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏Å‡∏≤‡πÅ‡∏ü" maxlength="50"></div>
      </div>
      <div class="actions">
        <button id="btnAddCatCancel" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnAddCatSave" class="btn-blue">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î</button>
      </div>
    </div>
  </div>

  <div id="editDebtBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editDebtTitle">
      <div id="editDebtTitle" class="title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</div>
      <input id="editDebtId" type="hidden">
      <div class="row">
        <div class="col"><label for="editDebtName">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label><input id="editDebtName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£ X / ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô A"></div>
        <div class="col"><label for="editDebtRate">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)</label><input id="editDebtRate" type="number" step="0.01"></div>
      </div>
      <div class="actions">
        <button id="btnEditDebtCancel" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnEditDebtSave" class="btn-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div id="pop" aria-live="assertive" role="alertdialog" aria-modal="true">
    <div class="pop-box">
      <div class="pop-icon">‚úì</div>
      <div class="pop-msg" id="popMsg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
    </div>
  </div>

  <div id="toast" aria-live="polite" role="status">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
  <div id="overlay"><div class="spinner" aria-hidden="true"></div></div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbznJMWIaEVx9NQurW2PO38SUQPSRoYFzSmhZCjNUIDJEFRLv1JmDC2XsQCoBUIlAbm8Uw/exec';
const BUD_CAT_OVERALL   = '__BUDGET_OVERALL__';
const BUD_CAT_SAVE_GOAL = '__SAVING_GOAL__';

/* ===== STATE ===== */
let token = localStorage.getItem('fin_token') || '';
let displayName = localStorage.getItem('fin_name') || '';
let lastItems = [];
let withdrawIncomeIds = new Set();
let debtsCache = []; // active debts
const monthSettingsCache = {}; // { 'YYYY-MM': {budget, goal} }

/* ===== HELPERS ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
function toast(msg, ok=true){ const el=$('#toast'); el.textContent=msg; el.style.background=ok?'#00c896':'#d63031'; el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',2400); }
function popSuccess(msg='‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'){ const p=$('#pop'); $('#popMsg').textContent=msg; p.classList.add('show'); clearTimeout(popSuccess._t); popSuccess._t=setTimeout(()=> p.classList.remove('show'), 1300); }
const showOverlay = (on)=> $('#overlay').classList.toggle('show', !!on);
const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
function todayISO(){ return toYMD(new Date()); }
function monthBoundsOf(d){ return { start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) }; }
function monthKeyNow(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function monthKeyFromRange(){ const f=$('#fFrom').value; if(!f) return monthKeyNow(); return f.slice(0,7); }
const sum = (arr, pick) => arr.reduce((s,x)=> s+(pick(x)||0), 0);
const groupBy = (arr, key) => arr.reduce((a,x)=> ((a[key(x)] = a[key(x)]||[]).push(x),a),{});
const runningSum = (arr)=>{ let s=0; return arr.map(v=>(s+=v,s)); };
const safeKey = (x)=> `${(x.date||'').slice(0,10)}T${(x.time||'00:00:00').slice(0,8)}`;
const clamp = (v,min,max)=> Math.min(max, Math.max(min, v||0));

/* Clear form on Add tab */
function clearAddForm(){
  $('#txDate').value = todayISO();
  setType('expense');
  $('#txAmount').value=''; $('#txNote').value='';
  $('#txInt').value=''; $('#txPrin').value='';
  if ($('#txCat').options.length) $('#txCat').selectedIndex = 0;
  if ($('#txDebt').options.length) $('#txDebt').selectedIndex = 0;
}

/* ===== fetch with timeout & light retry ===== */
async function fetchJSON(url, options={}, timeoutMs=20000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { ...options, signal: controller.signal });
    const text = await res.text();
    let j; try { j = JSON.parse(text); } catch(e){ return { ok:false, error:'NON_JSON', raw:text }; }
    return j;
  }catch(e){ return { ok:false, error:'NETWORK_ERROR', message:String(e&&e.message||e) }; }
  finally{ clearTimeout(id); }
}
async function api(path, payload={}, useToken=true, withOverlay=false){
  const body = { path, payload }; if (useToken && token) body.token = token;
  if (withOverlay) showOverlay(true);
  const isList = /\/list$/.test(path) || path.endsWith('transactions/list');
  try{
    const call = ()=> fetchJSON(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
    let j = await call();
    if ((!j.ok && j.error==='NETWORK_ERROR') && isList) j = await call();
    if (!j.ok && (j.error==='BAD_TOKEN' || j.error==='UNAUTHORIZED' || j.status===401)){
      localStorage.removeItem('fin_token'); token=''; ensureLoginUI(); toast('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', false);
    }
    if (!j.ok && j.error==='NON_JSON'){ toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô JSON)', false); }
    return j;
  }finally{ if (withOverlay) showOverlay(false); }
}

/* ===== BUDGETS ===== */
async function loadMonthSettingsFromAPI(mk){
  const r = await api('budgets/list', { month: mk }, true, false);
  let budget=0, goal=0;
  if (r.ok){
    for (const it of (r.items||[])) {
      const cid = String(it.category_id);
      if (cid === BUD_CAT_OVERALL)   budget = Number(it.limit_amount||0);
      if (cid === BUD_CAT_SAVE_GOAL) goal   = Number(it.limit_amount||0);
    }
  }
  monthSettingsCache[mk] = { budget, goal };
  $('#budgetThisMonth').value = budget ? String(budget) : '';
  $('#savingGoalThisMonth').value = goal ? String(goal) : '';
  return { budget, goal };
}
async function saveMonthSettingsToAPI(mk, budget, goal){
  const [r1, r2] = await Promise.all([
    api('budgets/upsert', { month: mk, category_id: BUD_CAT_OVERALL,   limit_amount: Number(budget||0) }, true, true),
    api('budgets/upsert', { month: mk, category_id: BUD_CAT_SAVE_GOAL, limit_amount: Number(goal||0)   }, true, true),
  ]);
  if (r1.ok && r2.ok){
    monthSettingsCache[mk] = { budget:Number(budget||0), goal:Number(goal||0) };
    $('#budgetThisMonth').value = budget ? String(budget) : '';
    $('#savingGoalThisMonth').value = goal ? String(goal) : '';
    return true;
  }
  return false;
}

/* ===== LOGIN & TABS ===== */
function switchTab(name){
  $$('.tabbtn').forEach(b=>{
    const on = (b.dataset.tab===name);
    b.classList.toggle('active', on);
    b.setAttribute('aria-selected', on?'true':'false');
  });
  $$('.section').forEach(s=>{
    const on = (s.id === 'tab-'+name);
    s.classList.toggle('active', on);
    if (on) { s.setAttribute('tabindex','-1'); s.focus(); }
  });
  if (name==='dash'){ ensureRangeDefaults(); refreshDash(); }
  if (name==='list'){ refreshDash(true); }
  if (name==='debt'){ ensureDebtDefaults(); loadDebtsUI(); }
}
$$('.tabbtn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

function ensureLoginUI(){
  if (token){
    $('#loginBox').classList.add('hide'); $('#app').classList.remove('hide');
    $('#who').textContent = displayName || localStorage.getItem('fin_user') || '';
    $('#txDate').value = todayISO();
    ensureRangeDefaults();
    loadCategoriesAll().then(async () => {
      populateCatSelect();
      await loadMonthSettingsFromAPI(monthKeyFromRange());
      await loadDebtsCache();
      fillDebtPickers();
      setTimeout(()=> $('#txAmount')?.focus(), 120);
    });
    refreshDash(true);
  } else {
    $('#loginBox').classList.remove('hide'); $('#app').classList.add('hide');
  }
}

$('#btnLogin').addEventListener('click', doLogin);
$('#inpPin').addEventListener('keydown', (e)=>{ if (e.key==='Enter') doLogin(); });
async function doLogin(){
  const user_id = $('#inpUser').value.trim();
  const pin = $('#inpPin').value.trim();
  if (!user_id || !pin){ $('#loginMsg').textContent='‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; toast('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', false); return; }
  $('#btnLogin').disabled = true; $('#loginMsg').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
  const j = await api('auth/login', { user_id, pin }, false, false);
  $('#btnLogin').disabled = false;
  if (!j.ok){ const msg=(j.error==='USER_NOT_FOUND')?'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ':(j.error==='BAD_PIN')?'‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î':(j.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#loginMsg').textContent=msg; toast(msg,false); return; }
  token = j.token; displayName = j.display_name || user_id;
  localStorage.setItem('fin_token', token); localStorage.setItem('fin_user', user_id); localStorage.setItem('fin_name', displayName);
  $('#loginMsg').textContent = ''; toast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!'); ensureLoginUI(); switchTab('add');
}
$('#btnLogout').addEventListener('click', ()=>{
  localStorage.removeItem('fin_token'); localStorage.removeItem('fin_name'); localStorage.removeItem('fin_user');
  token=''; displayName=''; $('#inpUser').value=''; $('#inpPin').value=''; $('#loginMsg').textContent=''; ensureLoginUI();
});

/* ===== CATEGORIES ===== */
let cats = { income:[], expense:[], saving:[] };
// ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡∏£‡∏≠‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà GAS ‡πÉ‡∏™‡πà)
function _isDebtFlowCat(c){
  const n = String(c?.name_th || '').trim();
  return n === '‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ' || n === '‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ';
}
function _isWithdrawIncomeName(name){ const s = String(name||''); return /‡∏ñ‡∏≠‡∏ô.*‡∏≠‡∏≠‡∏°|‡∏≠‡∏≠‡∏°.*‡∏ñ‡∏≠‡∏ô|‡∏ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏°|‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°|withdraw.*(save|saving)|saving.*withdraw/i.test(s); }
async function loadCategoriesAll(){
  for (const t of ['income','expense','saving']){
    const r = await api('categories/list', { type:t });
    cats[t] = r.ok ? (r.items||[]) : [];
  }
  withdrawIncomeIds = new Set((cats.income||[]).filter(c=> _isWithdrawIncomeName(c.name_th)).map(c=> c.category_id));
}
function populateCatSelect(){
  const t = $('#txType').value;
  const sel = $('#txCat');
  sel.innerHTML = '';

  // ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î ‚Äú‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ/‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡∏£‡∏≠‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏õ‡∏Å‡∏ï‡∏¥
  (cats[t] || [])
    .filter(c => !_isDebtFlowCat(c))
    .forEach(c => {
      const o = document.createElement('option');
      o.value = c.category_id;
      o.textContent = c.name_th;
      sel.appendChild(o);
    });

  // ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (!sel.options.length){
    const o = document.createElement('option');
    o.value = '';
    o.textContent = '‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ ‚Äî';
    sel.appendChild(o);
  }
}
$('#txType').addEventListener('change', populateCatSelect);

function openAddCatModal(){ $('#addCatType').value = $('#txType').value || 'expense'; $('#addCatName').value = ''; $('#addCatBackdrop').classList.add('show'); $('#addCatBackdrop').setAttribute('aria-hidden','false'); setTimeout(()=> $('#addCatName').focus(), 30); }
function closeAddCatModal(){ $('#addCatBackdrop').classList.remove('show'); $('#addCatBackdrop').setAttribute('aria-hidden','true'); }
$('#btnAddCatInline').addEventListener('click', openAddCatModal);
$('#btnAddCatCancel').addEventListener('click', closeAddCatModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAddCatModal(); });
async function createCategoryFromModal(){
  const type = $('#addCatType').value; const name = $('#addCatName').value.trim();
  if (!name){ toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô', false); $('#addCatName').focus(); return; }
  const r = await api('categories/create', { name_th:name, type }, true, true);
  if (!r.ok){ toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
  const newCatId = String(r.category_id || '');
  const newCatObj = { category_id: newCatId, name_th: name, type, user_id: 'self', is_active: true };
  cats[type] = [newCatObj, ...(cats[type]||[])];
  setType(type); populateCatSelect(); if (newCatId) $('#txCat').value = newCatId;
  closeAddCatModal();
  popSuccess('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadCategoriesAll().catch(()=>{});
}
$('#btnAddCatSave').addEventListener('click', createCategoryFromModal);
$('#addCatName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); createCategoryFromModal(); } });

/* ===== TYPE SWITCH ===== */
function setType(type){
  $('#txType').value = type;
  $('#btnTypeExp').classList.toggle('btn-green', type==='expense');
  $('#btnTypeInc').classList.toggle('btn-green', type==='income');
  $('#btnTypeSav').classList.toggle('btn-cyan',  type==='saving');
  $('#btnTypeDebtRepay').classList.toggle('btn-blue',   type==='debt_repay');
  $('#btnTypeDebtBorrow').classList.toggle('btn-blue',  type==='debt_borrow');
  $('#btnTypeExp').setAttribute('aria-pressed', type==='expense');
  $('#btnTypeInc').setAttribute('aria-pressed', type==='income');
  $('#btnTypeSav').setAttribute('aria-pressed', type==='saving');
  $('#btnTypeDebtRepay').setAttribute('aria-pressed', type==='debt_repay');
  $('#btnTypeDebtBorrow').setAttribute('aria-pressed', type==='debt_borrow');
  const debtMode = (type==='debt_repay' || type==='debt_borrow');
  $('#colCat').classList.toggle('hide', debtMode);
  $('#colDebt').classList.toggle('hide', !debtMode);
  const isRepay = (type==='debt_repay');
  $('#colDebtRepayFields').classList.toggle('hide', !isRepay);
  $('#colAmount').classList.toggle('hide', isRepay);
  if (!debtMode) { populateCatSelect(); }
  else { fillDebtPickers(); }
}
$('#btnTypeExp').addEventListener('click', ()=> setType('expense'));
$('#btnTypeInc').addEventListener('click', ()=> setType('income'));
$('#btnTypeSav').addEventListener('click', ()=> setType('saving'));
$('#btnTypeDebtRepay').addEventListener('click', ()=> setType('debt_repay'));
$('#btnTypeDebtBorrow').addEventListener('click', ()=> setType('debt_borrow'));

/* ===== ADD TRANSACTION ===== */
function normalizeAmount(v){ const n=Number(v); if (!isFinite(n) || n<=0) return NaN; return Math.round(n*100)/100; }
async function saveTx(){
  const type = $('#txType').value;
  const date = $('#txDate').value;
  const note = $('#txNote').value.trim();
  if (!date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', false); return; }
  $('#btnSave').disabled = true;

  if (type==='debt_repay' || type==='debt_borrow'){
    const debt_id = $('#txDebt').value;
    if (!debt_id){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', false); $('#btnSave').disabled=false; return; }

    if (type==='debt_repay'){
      const interest = Number($('#txInt').value||0);
      const principal = Number($('#txPrin').value||0);
      const amount = Math.round((interest + principal) * 100) / 100;
      if (!(isFinite(amount) && amount>0)){ toast('‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å/‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); $('#btnSave').disabled=false; return; }
      const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
      $('#btnSave').disabled = false;
      if (r.ok){
        popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        clearAddForm();
        await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
      } else { toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); }
      return;
    } else {
      const amount = normalizeAmount($('#txAmount').value);
      if (isNaN(amount)){ toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); $('#btnSave').disabled=false; return; }
      const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
      $('#btnSave').disabled = false;
      if (r.ok){
        popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        clearAddForm();
        await loadDebtsCache(); refreshDash(true); loadDebtsUI(); $('#txAmount').focus();
      } else { toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); }
      return;
    }
  }

  const amount = normalizeAmount($('#txAmount').value);
  const category_id = $('#txCat').value;
  if (isNaN(amount)){ toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); $('#btnSave').disabled=false; return; }
  if (!category_id){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î', false); $('#btnSave').disabled=false; return; }

  const payload = { date, type, category_id, amount, note };
  const r = await api('transactions/create', payload, true, true);
  $('#btnSave').disabled = false;
  if (r.ok){
    popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    clearAddForm();
    refreshDash(true); $('#txAmount').focus();
  } else {
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }
}
$('#btnSave').addEventListener('click', ()=> saveTx());
$('#tab-add').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); saveTx(); } });

/* ===== DASHBOARD ===== */
let chartExp=null, chartFlow=null, chartSavCum=null, chartDebtTS=null, chartPI=null;
function setKpiLoading(on){
  ['sumIncome','sumExpense','sumSaving','sumNet','sumDebt'].forEach(id=>{
    const el=$('#'+id);
    if (on){ el.classList.add('skeleton'); el.textContent=''; }
    else   { el.classList.remove('skeleton'); }
  });
}
function colorizeNetCard(netVal){ $('#netCard').style.border = netVal>=0 ? '1px solid rgba(0,200,150,.35)' : '1px solid rgba(255,77,79,.35)'; }
function setRangeDaysBack(days){
  const now = new Date(); const from = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to = toYMD(now);
  $('#fFrom').value = from; $('#fTo').value = to; onRangeChange();
}
$('#btnToday').addEventListener('click', ()=>{ const d=todayISO(); $('#fFrom').value=d; $('#fTo').value=d; onRangeChange(); });
$('#btn7').addEventListener('click', ()=> setRangeDaysBack(7));
$('#btn30').addEventListener('click', ()=> setRangeDaysBack(30));
$('#btnMonth').addEventListener('click', ()=>{ const mb=monthBoundsOf(new Date()); $('#fFrom').value=mb.start; $('#fTo').value=mb.end; onRangeChange(); });
$('#btnYear').addEventListener('click', ()=>{ const y=new Date().getFullYear(); $('#fFrom').value=`${y}-01-01`; $('#fTo').value=`${y}-12-31`; onRangeChange(); });
$('#btnRefresh').addEventListener('click', ()=> refreshDash());
$('#btnSaveBudget').addEventListener('click', async ()=>{
  const mk = monthKeyFromRange();
  const ok = await saveMonthSettingsToAPI(mk, $('#budgetThisMonth').value, $('#savingGoalThisMonth').value);
  if (ok){ popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö/‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); await refreshDash(true); }
  else toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö/‡πÄ‡∏õ‡πâ‡∏≤‡∏≠‡∏≠‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
});
function onRangeChange(){ updateRangeUI(); refreshDash(); }
$('#fFrom').addEventListener('change', onRangeChange);
$('#fTo').addEventListener('change', onRangeChange);

function ensureRangeDefaults(){
  if (!$('#fFrom').value || !$('#fTo').value){
    const now = new Date(); const mb = monthBoundsOf(now);
    $('#fFrom').value = mb.start; $('#fTo').value = mb.end;
  }
  updateRangeUI();
}
function updateRangeUI(){
  const f=$('#fFrom').value, t=$('#fTo').value;
  const today=todayISO(); const mb = monthBoundsOf(new Date());
  const now=new Date();
  const last7  = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-6));
  const last30 = toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-29));
  const yStart= `${now.getFullYear()}-01-01`, yEnd=`${now.getFullYear()}-12-31`;

  const isToday = (f===today && t===today);
  const is7     = (f===last7  && t===today);
  const is30    = (f===last30 && t===today);
  const isMonth = (f===mb.start && t===mb.end);
  const isYear  = (f===yStart && t===yEnd);

  $('#btnToday').classList.toggle('active', isToday);
  $('#btn7').classList.toggle('active', is7);
  $('#btn30').classList.toggle('active', is30);
  $('#btnMonth').classList.toggle('active', isMonth);
  $('#btnYear').classList.toggle('active', isYear);

  let txt='‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á';
  if (isToday) txt='‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
  else if (is7) txt='7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  else if (is30) txt='30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  else if (isMonth) txt='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
  else if (isYear) txt='‡∏õ‡∏µ‡∏ô‡∏µ‡πâ';
  $('#rangeBadge').textContent = txt;
}

/* ===== DEBTS MODULE ===== */
async function loadDebtsCache(){
  const r = await api('debts/list', {}, true, false);
  debtsCache = r.ok ? (r.items||[]) : [];
  fillDebtPickers();
}
function fillDebtPickers(){
  const selects = ['#txDebt','#dqDebt','#dtDebt'];
  selects.forEach(sel=>{
    const el = $(sel); if (!el) return;
    const keep = el.value;
    el.innerHTML = (sel==='#dtDebt') ? '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' : '';
    (debtsCache||[]).forEach(d=>{
      const o=document.createElement('option');
      o.value=d.debt_id; o.textContent=d.lender_name || d.debt_id;
      el.appendChild(o);
    });
    if (keep) el.value = keep;
  });
}
function ensureDebtDefaults(){
  if (!$('#dqDate').value) $('#dqDate').value = todayISO();
  if (!$('#dtFrom').value || !$('#dtTo').value){
    const mb = monthBoundsOf(new Date()); $('#dtFrom').value = mb.start; $('#dtTo').value = mb.end;
  }
}

$('#dqType').addEventListener('change', ()=>{
  const t = $('#dqType').value;
  const isRepay = (t==='repay');
  $('#dqColRepay1').classList.toggle('hide', !isRepay);
  $('#dqColRepay2').classList.toggle('hide', !isRepay);
  $('#dqColAmount').classList.toggle('hide', isRepay);
});
$('#dqType').dispatchEvent(new Event('change'));

$('#btnAddDebt').addEventListener('click', async ()=>{
  const lender_name = $('#dName').value.trim();
  const annual_rate = Number($('#dRate').value||0);
  const principal_initial = Number($('#dPrincipal').value||0);
  if (!lender_name || !isFinite(annual_rate) || annual_rate<0){ toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
  const payload = { lender_name, annual_rate, principal_initial: isFinite(principal_initial)&&principal_initial>0? principal_initial:0, start_date: todayISO() };
  const r = await api('debts/create', payload, true, true);
  if (r.ok){ popSuccess('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#dName').value=''; $('#dRate').value=''; $('#dPrincipal').value=''; await loadDebtsUI(); fillDebtPickers(); refreshDash(true); }
  else toast(r.message||'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
});
$('#btnDebtQuick').addEventListener('click', async ()=>{
  const type = $('#dqType').value; const debt_id = $('#dqDebt').value; const date = $('#dqDate').value; const note = $('#dqNote').value.trim();
  if (!debt_id || !date){ toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', false); return; }
  if (type==='repay'){
    const interest = Number($('#dqInt').value||0);
    const principal = Number($('#dqPrin').value||0);
    const amount = Math.round((interest + principal) * 100)/100;
    if (!(isFinite(amount)&&amount>0)){ toast('‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å/‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
    const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true, true);
    if (r.ok){ popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#dqInt').value=''; $('#dqPrin').value=''; $('#dqNote').value=''; await loadDebtsUI(); refreshDash(true); }
    else toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }else{
    const amount = Number($('#dqAmount').value||0);
    if (!(isFinite(amount)&&amount>0)){ toast('‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
    const r = await api('debts/borrow', { debt_id, date, amount, note }, true, true);
    if (r.ok){ popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#dqAmount').value=''; $('#dqNote').value=''; await loadDebtsUI(); refreshDash(true); }
    else toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }
});
$('#btnLoadDebtTx').addEventListener('click', loadDebtTxList);
async function loadDebtTxList(){
  const from = $('#dtFrom').value, to = $('#dtTo').value, debtId = $('#dtDebt').value;
  const r = await api('debts/tx/list', { from, to, debt_id: debtId||undefined }, true, true);
  const tb = $('#tblDebtTx'); tb.innerHTML='';
  if (!r.ok){ toast('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
  const items = (r.items||[]);
  const nameMap = Object.fromEntries((debtsCache||[]).map(d=>[d.debt_id, d.lender_name]));
  for (const x of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc((x.date||'').slice(0,10))}</td>
      <td><span class="badge badge-debt">${x.type==='borrow'?'‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ':'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ'}</span></td>
      <td>${esc(nameMap[x.debt_id] || x.debt_id)}</td>
      <td class="right">${fmt(x.amount)}</td>
      <td class="right">${fmt(x.interest_paid||0)}</td>
      <td class="right">${fmt(x.principal_paid||0)}</td>
      <td class="right">${fmt(x.overpay||0)}</td>
      <td>${esc(x.note||'')}</td>`;
    tb.appendChild(tr);
  }
}

async function refreshDash(silent){
  if (!token){ if(!silent) toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö token (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô)', false); return; }
  setKpiLoading(true);
  if (!cats.expense.length && !cats.income.length && !cats.saving.length){ await loadCategoriesAll(); }
  await loadDebtsCache();

  const mk = monthKeyFromRange();
  await loadMonthSettingsFromAPI(mk).catch(()=>{});

  const from = $('#fFrom').value, to = $('#fTo').value;
  const [rTx, rDebtSum] = await Promise.all([
    api('transactions/list', { from, to, type:'all' }),
    api('debts/summary', {}, true, false)
  ]);
  if (!rTx.ok){ setKpiLoading(false); if(!silent) toast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
  lastItems = (rTx.items||[]).map(x=> ({...x, amount:+x.amount}));

  const inc = sum(lastItems, x=> x.type==='income'? x.amount:0);
  const exp = sum(lastItems, x=> x.type==='expense'? x.amount:0);
  const savDep = sum(lastItems, x=> x.type==='saving'? x.amount:0);
  const savWd  = sum(lastItems, x=> x.type==='income' && withdrawIncomeIds.has(x.category_id) ? x.amount : 0);
  const savNet = savDep - savWd;
  const net    = inc - exp - savDep;

  $('#sumIncome').textContent = fmt(inc);
  $('#sumExpense').textContent = fmt(exp);
  $('#sumSaving').textContent  = fmt(Math.max(0, savNet));
  $('#sumNet').textContent     = fmt(net);
  colorizeNetCard(net);
  $('#sumDebt').textContent = rDebtSum.ok ? fmt(Number(rDebtSum.totals?.total||0)) : '‚Äî';
  setKpiLoading(false);

  await updateBudgetUI(exp, Math.max(0,savNet), mk);

  const mapCat = Object.fromEntries((cats.expense.concat(cats.income).concat(cats.saving)).map(c=> [c.category_id, c.name_th]));
  drawExpByCat(lastItems, mapCat);
  drawFlow(lastItems);
  drawSavingCum(lastItems);
  renderTable(lastItems, mapCat);

  await drawDebtNetTotalOverTime(from, to);
  await drawPrincipalInterestMonthly_Manual(from, to);
}
async function updateBudgetUI(expenseTotal, savingNet, mk){
  const cache = monthSettingsCache[mk] || { budget:0, goal:0 };
  const b = Number(cache.budget||0), g = Number(cache.goal||0);

  const pct = (!b || b<=0) ? 0 : Math.round((expenseTotal/b)*100);
  $('#budgetUsedPct').textContent = b>0 ? `${pct}%` : '‚Äî';
  $('#budgetBar').style.width = (b>0 ? Math.min(pct,100) : 0) + '%';
  $('#budgetBar').style.filter = (pct>=100)? 'saturate(1.5)' : (pct>=80? 'saturate(1.2)' : 'none');

  let bTxt = '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‚Äî';
  if (b>0){
    if (expenseTotal > b) bTxt = `‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤ ${fmt(expenseTotal - b)}`;
    else                  bTxt = `‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ö ${fmt(b - expenseTotal)}`;
  }
  $('#budgetStatus').textContent = bTxt;

  const savingClamped = Math.max(0, savingNet);
  const pctSave = (!g || g<=0) ? 0 : Math.round((savingClamped/g)*100);
  $('#savingGoalPct').textContent = g>0 ? `${pctSave}%` : '‚Äî';
  $('#savingBar').style.width = (g>0 ? Math.min(pctSave,100) : 0) + '%';

  let sTxt='‚Äî';
  if (g>0){
    if (savingNet>=g) sTxt = `‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß (+${fmt(savingNet-g)})`;
    else              sTxt = `‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${fmt(g - savingNet)}`;
  }
  $('#savingGoalStatus').textContent = sTxt;
}

/* Charts */
function drawExpByCat(items, mapCat){
  const panelNo = $('#noDataExp'); if (chartExp) chartExp.destroy();
  const exps = items.filter(x=>x.type==='expense');
  if (!exps.length){ panelNo.classList.remove('hide'); chartExp=null; return; }
  panelNo.classList.add('hide');
  const groupExp = groupBy(exps, x=> mapCat[x.category_id] || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ');
  const labels = Object.keys(groupExp);
  const data = labels.map(k=> sum(groupExp[k], x=> x.amount));
  chartExp = new Chart($('#chartExp'), {
    type:'bar',
    data:{ labels, datasets:[{ label:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)', data, backgroundColor:'rgba(233,30,99,0.65)', borderColor:'rgba(233,30,99,1)', borderWidth:1 }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ display:false } } }
  });
}
function drawFlow(items){
  const panelNo = $('#noDataFlow'); if (chartFlow) chartFlow.destroy();
  if (!items.length){ panelNo.classList.remove('hide'); chartFlow=null; return; }
  panelNo.classList.add('hide');
  const g = groupBy(items, x=> x.date);
  const ds = Object.keys(g).sort();
  const income  = ds.map(d=> sum(g[d], x=> x.type==='income'?  x.amount:0));
  const expense = ds.map(d=> sum(g[d], x=> x.type==='expense'? x.amount:0));
  const savingD = ds.map(d=> sum(g[d], x=> x.type==='saving'?  x.amount:0));
  const netDaily = ds.map((_,i)=> income[i] - expense[i] - savingD[i]);
  const netCumulative = runningSum(netDaily);
  chartFlow = new Chart($('#chartFlow'), {
    type:'line',
    data:{ labels: ds,
      datasets:[
        { label:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', data:income, borderColor:'#00c896', backgroundColor:'rgba(0,200,150,.15)', tension:.35, fill:false },
        { label:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', data:expense, borderColor:'#ff4d4f', backgroundColor:'rgba(255,77,79,.15)', tension:.35, fill:false },
        { label:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∞‡∏™‡∏°', data:netCumulative, borderColor:'#6c8cff', backgroundColor:'rgba(108,140,255,.15)', tension:.35, fill:false }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:true } } }
  });
}
function drawSavingCum(items){
  const panelNo = $('#noDataSav'); if (chartSavCum) chartSavCum.destroy();
  const byDateDep = groupBy(items.filter(x=>x.type==='saving'), x=> x.date);
  const byDateWdr = groupBy(items.filter(x=> x.type==='income' && withdrawIncomeIds.has(x.category_id)), x=> x.date);
  const dates = Array.from(new Set([...Object.keys(byDateDep), ...Object.keys(byDateWdr)])).sort();
  if (!dates.length){ panelNo.classList.remove('hide'); chartSavCum=null; return; }
  panelNo.classList.add('hide');
  const netPerDay = dates.map(d=>{
    const dep = sum(byDateDep[d]||[], x=> x.amount);
    const wdr = sum(byDateWdr[d]||[], x=> x.amount);
    return dep - wdr;
  });
  const cum = runningSum(netPerDay);
  chartSavCum = new Chart($('#chartSavCum'), {
    type:'line',
    data:{ labels: dates, datasets:[{ label:'‡∏≠‡∏≠‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏∞‡∏™‡∏°', data:cum, borderColor:'#2dd4bf', backgroundColor:'rgba(45,212,191,.15)', tension:.35, fill:false }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}}
  });
}

/* ===== LIST + EDIT ===== */
function renderTable(items, mapCat){
  const tb = $('#tblBody'); tb.innerHTML='';
  const sorted = items.slice().sort((a,b)=> safeKey(b).localeCompare(safeKey(a)));
  if (!sorted.length){ $('#emptyList').style.display='block'; return; }
  $('#emptyList').style.display='none';
  for (const x of sorted){
    const isWithdrawIncome = (x.type==='income' && withdrawIncomeIds.has(x.category_id));
    const typeTxt = x.type==='income'?(isWithdrawIncome?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ñ‡∏≠‡∏ô‡∏≠‡∏≠‡∏°)':'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'):(x.type==='saving'?'‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢');
    const badge = x.type==='income' ? (isWithdrawIncome ? 'badge-sav' : 'badge-inc') : (x.type==='saving' ? 'badge-sav' : 'badge-exp');
    const catName = mapCat[x.category_id] || x.category_name || x.category_id || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${esc(x.date||'').slice(0,10)}">${esc((x.date||'').slice(0,10))}</td>
      <td><span class="badge ${badge}">${typeTxt}</span></td>
      <td>${esc(catName)}</td>
      <td class="right">${fmt(x.amount)}</td>
      <td>${esc(x.note||'')}</td>
      <td><button class="btn-ghost" data-act="edit" data-id="${esc(x.tx_id||'')}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>`;
    tb.appendChild(tr);
  }
}
$('#tblBody').addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('button[data-act="edit"]');
  if (!btn) return;
  openEditById(btn.getAttribute('data-id'));
});
function populateEditCatSelect(){
  const t = $('#editType').value; const sel = $('#editCat'); sel.innerHTML='';
  (cats[t]||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.category_id; o.textContent=c.name_th; sel.appendChild(o); });
}

/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `openEditById` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ (‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ GAS) */
async function openEditById(txId){
  if (!txId){ toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', false); return; }
  let it = lastItems.find(x=> String(x.tx_id)===String(txId));
  if (!it){
    const r = await api('transactions/list', { from: $('#fFrom').value, to: $('#fTo').value, type:'all' });
    if (!r.ok){ toast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
    lastItems = (r.items||[]); it = lastItems.find(x=> String(x.tx_id)===String(txId));
    if (!it){ toast('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', false); return; }
  }

  const allCats = [...(cats.expense||[]), ...(cats.income||[]), ...(cats.saving||[])];
  const catMap = Object.fromEntries(allCats.map(c => [c.category_id, c.name_th]));
  
  const catName = catMap[it.category_id] || it.category_name || '';
  const isDebtRepay = catName.includes('‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ');
  
  $('#editBackdrop').dataset.isDebtRepay = isDebtRepay;

  $('#editTxId').value = it.tx_id;
  $('#editDate').value = (it.date||'').slice(0,10);
  $('#editType').value = it.type;
  populateEditCatSelect();
  $('#editCat').value = it.category_id;
  $('#editNote').value = it.note||'';
  
  $('#editColType').classList.toggle('hide', isDebtRepay);
  $('#editColCat').classList.toggle('hide', isDebtRepay);
  $('#editColAmount').classList.toggle('hide', isDebtRepay);
  $('#editColDebtRepayFields').classList.toggle('hide', !isDebtRepay);

  $('#editBackdrop').classList.add('show');
  $('#editBackdrop').setAttribute('aria-hidden','false');
  
  if (isDebtRepay) {
    $('#editPrin').value = '';
    $('#editInt').value = '';
    
    $('#editColAmount').classList.remove('hide');
    $('#editAmount').readOnly = true;
    $('#editAmount').value = Number(it.amount).toFixed(2);
    
    const updateTotal = () => {
        const prin = Number($('#editPrin').value) || 0;
        const intr = Number($('#editInt').value) || 0;
        $('#editAmount').value = (prin + intr).toFixed(2);
    };
    $('#editPrin').oninput = updateTotal;
    $('#editInt').oninput = updateTotal;
    
    $('#editType').disabled = true;
    $('#editCat').disabled = true;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API `debts/tx/get` ---
    if (it.debt_tx_id) {
        showOverlay(true);
        const debtDetails = await api('debts/tx/get', { tx_id: it.debt_tx_id });
        showOverlay(false);
        if (debtDetails.ok && debtDetails.item) {
            $('#editPrin').value = debtDetails.item.principal_paid || '0';
            $('#editInt').value = debtDetails.item.interest_paid || '0';
            updateTotal(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        } else {
            toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ', false);
        }
    }

  } else {
    $('#editAmount').value = String(it.amount);
    $('#editAmount').readOnly = false;
    $('#editPrin').oninput = null;
    $('#editInt').oninput = null;
    $('#editType').disabled = false;
    $('#editCat').disabled = false;
  }
}

function closeEdit(){ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); }
$('#btnCancel').addEventListener('click', closeEdit);
$('#editType').addEventListener('change', populateEditCatSelect);

/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Event Listener ‡∏Ç‡∏≠‡∏á `#btnUpdate` ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á */
$('#btnUpdate').addEventListener('click', async ()=>{
  const tx_id = $('#editTxId').value;
  const isDebtRepay = $('#editBackdrop').dataset.isDebtRepay === 'true';

  $('#btnUpdate').disabled = true;
  let r;

  if (isDebtRepay) {
    const principal_paid = Number($('#editPrin').value);
    const interest_paid = Number($('#editInt').value);
    const amount = principal_paid + interest_paid;

    if (!tx_id || !isFinite(amount) || amount < 0) {
      toast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false);
      $('#btnUpdate').disabled = false;
      return;
    }
    
    const originalItem = lastItems.find(it => String(it.tx_id) === String(tx_id));
    const debt_tx_id = originalItem ? originalItem.debt_tx_id : '';
    if (!debt_tx_id) {
       toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ô', false);
       $('#btnUpdate').disabled = false;
       return;
    }

    const payload = {
      debt_tx_id: debt_tx_id,
      date: $('#editDate').value,
      note: $('#editNote').value.trim(),
      principal_paid: Math.round(principal_paid * 100) / 100,
      interest_paid: Math.round(interest_paid * 100) / 100
    };
    
    r = await api('debts/tx/update', payload, true, true);
  } else {
    const amount = Number($('#editAmount').value);
    if (!tx_id || !isFinite(amount) || amount <= 0){
      toast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false);
      $('#btnUpdate').disabled = false;
      return;
    }
    const payload = {
      tx_id,
      date: $('#editDate').value,
      type: $('#editType').value,
      category_id: $('#editCat').value,
      amount: Math.round(amount*100)/100,
      note: $('#editNote').value.trim()
    };
    r = await api('transactions/update', payload, true, true);
  }

  $('#btnUpdate').disabled = false;
  if (r.ok){
    popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    closeEdit();
    await refreshDash(true);
    if (isDebtRepay) {
        await loadDebtsUI();
    }
  } else {
    toast(r.message||'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }
});

/* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ refresh ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
$('#btnDelete').addEventListener('click', async ()=>{
  $('#confirmMsg').textContent='‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?';
  $('#confirmBackdrop').classList.add('show');
  $('#confirmBackdrop').setAttribute('aria-hidden','false');
  const ok = await new Promise(resolve=>{
    const yes=()=>{ cleanup(); resolve(true); };
    const no =()=>{ cleanup(); resolve(false); };
    const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
      $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
    $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
  });
  if (!ok) return;
  const tx_id = $('#editTxId').value; if (!tx_id) return;
  const isDebtRepay = $('#editBackdrop').dataset.isDebtRepay === 'true';
  $('#btnDelete').disabled = true;
  const r = await api('transactions/delete', { tx_id }, true, false);
  $('#btnDelete').disabled = false;
  if (r.ok){
    popSuccess('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    closeEdit();
    await refreshDash(true);
    if (isDebtRepay) {
      await loadDebtsUI();
    }
  } else toast(r.message||'‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
});


/* ===== Debts list + edit modal ===== */
async function loadDebtsUI(){
  await loadDebtsCache();
  const rSum = await api('debts/summary', {}, true, false);
  const mapById = Object.fromEntries((debtsCache||[]).map(d=> [d.debt_id, d]));
  const tb = $('#tblDebts'); tb.innerHTML='';
  const rows = (rSum.ok ? (rSum.items||[]) : []).map(x=>{
    const d = mapById[x.debt_id] || {};
    const principal = Number(x.principal_current ?? d.principal_current ?? 0);
    const accrued   = Number(x.accrued_interest  ?? d.accrued_interest  ?? 0);
    const rate      = Number(x.annual_rate       ?? d.annual_rate       ?? 0);
    const total_due = (typeof x.total_due === 'number' && Number.isFinite(x.total_due))
      ? x.total_due
      : principal + accrued;
    return {
      debt_id: x.debt_id,
      lender_name: x.lender_name || d.lender_name || '',
      rate,
      principal,
      accrued,
      total: total_due,
      last_calc_date: d.last_calc_date || x.as_of || ''
    };
  });
  if (rows.length === 0) {
    tb.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</td></tr>';
    return;
  }
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.lender_name)}</td>
      <td class="right">${fmt(r.rate)}</td>
      <td class="right">${fmt(r.principal)}</td>
      <td class="right">${fmt(r.accrued)}</td>
      <td class="right"><b>${fmt(r.total)}</b></td>
      <td>${esc((r.last_calc_date||'').slice(0,10))}</td>
      <td>
        <div class="actions">
          <button class="btn-ghost" data-dact="edit"  data-id="${esc(r.debt_id)}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn-danger" data-dact="close" data-id="${esc(r.debt_id)}">‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  }
}

function findClosest(el, selector, stopAt){
  if (el && el.nodeType === 3) el = el.parentElement;
  while (el && el !== stopAt){
    if (el.matches && el.matches(selector)) return el;
    el = el.parentElement;
  }
  return null;
}
function openDebtEdit(id){
  const d = debtsCache.find(x=> String(x.debt_id)===String(id));
  if (!d){ toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', false); return; }
  $('#editDebtId').value = d.debt_id;
  $('#editDebtName').value = d.lender_name || '';
  $('#editDebtRate').value = (d.annual_rate ?? 0);
  $('#editDebtBackdrop').classList.add('show');
  $('#editDebtBackdrop').setAttribute('aria-hidden','false');
  setTimeout(()=> $('#editDebtName').focus(), 50);
}
function closeDebtEdit(){
  $('#editDebtBackdrop').classList.remove('show');
  $('#editDebtBackdrop').setAttribute('aria-hidden','true');
}
$('#btnEditDebtCancel').addEventListener('click', closeDebtEdit);
$('#btnEditDebtSave').addEventListener('click', async ()=>{
  const id = $('#editDebtId').value;
  const name = $('#editDebtName').value.trim();
  const rate = Number($('#editDebtRate').value);
  if (!id){ toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', false); return; }
  if (!name){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', false); return; }
  if (!isFinite(rate) || rate<0){ toast('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
  const r = await api('debts/update', { debt_id:id, lender_name:name, annual_rate:Math.round(rate*100)/100 }, true, true);
  if (r.ok){ popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); closeDebtEdit(); await loadDebtsUI(); refreshDash(true); }
  else toast(r.message||'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
});
$('#tblDebts').addEventListener('click', async (e)=>{
  const btn = findClosest(e.target, 'button[data-dact]', e.currentTarget);
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-dact');

  if (act==='close'){
    $('#confirmMsg').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
    $('#confirmBackdrop').classList.add('show'); $('#confirmBackdrop').setAttribute('aria-hidden','false');
    const ok = await new Promise(resolve=>{
      const yes=()=>{ cleanup(); resolve(true); }; const no =()=>{ cleanup(); resolve(false); };
      const cleanup=()=>{ $('#btnYes').removeEventListener('click', yes); $('#btnNo').removeEventListener('click', no);
        $('#confirmBackdrop').classList.remove('show'); $('#confirmBackdrop').setAttribute('aria-hidden','true'); };
      $('#btnYes').addEventListener('click', yes); $('#btnNo').addEventListener('click', no);
    });
    if (!ok) return;
    const r = await api('debts/close', { debt_id:id }, true, true);
    if (r.ok){ popSuccess('‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); await loadDebtsUI(); refreshDash(true); }
    else toast(r.message||'‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }
  if (act==='edit'){ openDebtEdit(id); }
});

/* ===== Debt charts (principal only) ===== */
function normRangeForCharts(from, to){
  const today = todayISO();
  const end = (!to || to > today) ? today : to;
  return { from, end };
}
async function drawDebtNetTotalOverTime(from, to){
  const panelNo = $('#noDataDebtTS');
  if (chartDebtTS) chartDebtTS.destroy();

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"
  const today = todayISO();
  const end = (!to || to > today) ? today : to;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô
  const days = dateRangeArray(from, end);
  if (!days.length){ panelNo.classList.remove('hide'); chartDebtTS = null; return; }

  // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å, ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°, ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
  await loadDebtsCache(); // ‡πÄ‡∏ï‡∏¥‡∏° debtsCache ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  const debts = (debtsCache || []).map(d => ({
    id: String(d.debt_id),
    name: d.lender_name || '',
    rate: Number(d.annual_rate || 0),          // ‡∏ï‡πà‡∏≠‡∏õ‡∏µ (%)
    start: (d.start_date || d.created_at || '').slice(0,10) || from,
    p0: Number(d.principal_initial || 0),      // ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á
    pcur: Number(d.principal_current || 0),    // ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (fallback)
    accrued0: Number(d.accrued_interest || 0), // ‡∏î‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö)
  }));

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
  if (!debts.length){ panelNo.classList.remove('hide'); chartDebtTS = null; return; }

  // 2) ‡πÇ‡∏´‡∏•‡∏î TX ‡∏´‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á end ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
  const rTx = await api('debts/tx/list', { to: end }, true, false);
  const txItems = (rTx.ok ? (rTx.items||[]) : []).map(x => ({
    date: String(x.date||'').slice(0,10),
    debt_id: String(x.debt_id||''),
    type: String(x.type||''), // 'borrow' | 'repay'
    amount: Number(x.amount||0),
    principal_paid: Number(x.principal_paid||0),
    interest_paid: Number(x.interest_paid||0),
  }));

  // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° TX ‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ-‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
  const txByDebtDate = {};
  for (const t of txItems){
    const key = `${t.debt_id}__${t.date}`;
    (txByDebtDate[key] ||= []).push(t);
  }

  // 3) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô from
  //    ‡πÉ‡∏ä‡πâ p0 ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡∏∞ start < from; ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ p0 ‡πÉ‡∏´‡πâ fallback ‡πÄ‡∏õ‡πá‡∏ô pcur (‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠ snapshot)
  const daily = []; // ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (principal + accrued)
  const ONE_DAY_RATE = (annualPercent) => (Number(annualPercent||0) / 100) / 365;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á
  const states = debts.map(d => {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô ‡∏ì "‡∏Å‡πà‡∏≠‡∏ô from"
    let principal = 0;
    if (d.p0 > 0 && d.start && d.start < from) {
      principal = d.p0;
    } else if (d.pcur > 0 && d.start && d.start < from) {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ p0 ‡πÅ‡∏ï‡πà‡∏°‡∏µ pcur ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ pcur ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô
      principal = d.pcur;
    }
    return {
      id: d.id,
      rate: d.rate,
      start: d.start,
      principal,
      accrued: 0, // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≠‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å 0 (‡∏à‡∏∞‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)
    };
  });

  // ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏ß‡∏±‡∏ô: ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏à‡∏≤‡∏Å TX ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î "‡∏Å‡πà‡∏≠‡∏ô from" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô principal (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô)
  for (const st of states){
    // ‡∏´‡∏≤‡∏à‡∏≤‡∏Å tx ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏µ‡πâ
    const txBefore = txItems
      .filter(t => t.debt_id === st.id && t.date < from)
      .sort((a,b)=> a.date.localeCompare(b.date));
    // ‡πÄ‡∏ï‡∏¥‡∏°/‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    for (const t of txBefore){
      if (t.type === 'borrow') st.principal += t.amount;
      if (t.type === 'repay')  st.principal = Math.max(0, st.principal - t.principal_paid);
      // ‡∏î‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏î‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π
    }
  }

  // 4) ‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á: ‡∏™‡∏∞‡∏™‡∏°‡∏î‡∏≠‡∏Å + ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å TX ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
  for (const day of days){
    // 4.1 ‡∏Ñ‡∏¥‡∏î‡∏î‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å "principal ‡∏ì ‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô"
    for (const st of states){
      // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏î
      if (st.start && st.start > day) continue;
      if (st.principal > 0){
        st.accrued += st.principal * ONE_DAY_RATE(st.rate);
      }
    }

    // 4.2 ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° TX ‡πÉ‡∏ô "day"
    for (const st of states){
      const key = `${st.id}__${day}`;
      const list = txByDebtDate[key] || [];
      if (!list.length) continue;
      for (const t of list){
        if (t.type === 'borrow'){
          st.principal += t.amount; // ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô
        } else if (t.type === 'repay'){
          // ‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å
          st.accrued = Math.max(0, st.accrued - (t.interest_paid||0));
          // ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô
          st.principal = Math.max(0, st.principal - (t.principal_paid||0));
        }
      }
    }

    // 4.3 ‡∏£‡∏ß‡∏°‡∏ú‡∏• ‚Äú‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‚Äù ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    const sumToday = states.reduce((s,st)=> s + st.principal + st.accrued, 0);
    daily.push(sumToday);
  }

  // 5) ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  const any = daily.some(v => v > 0);
  if (!any){ panelNo.classList.remove('hide'); chartDebtTS = null; return; }

  panelNo.classList.add('hide');
  chartDebtTS = new Chart($('#chartDebtTS'), {
    type:'line',
    data:{
      labels: days,
      datasets:[{
        label:'‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
        data: daily,
        borderColor:'#6c8cff',
        backgroundColor:'rgba(108,140,255,.15)',
        tension:.35,
        fill:false
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      scales:{ y:{ beginAtZero:true } },
      plugins:{ legend:{ display:true }}
    }
  });
}
async function drawPrincipalInterestMonthly_Manual(from, to){
  const panelNo = $('#noDataPI'); if (chartPI) chartPI.destroy();
  const { end } = normRangeForCharts(from, to);
  const r = await api('debts/tx/list', { from, to:end }, true, false);
  if (!r.ok || !(r.items||[]).length){ panelNo.classList.remove('hide'); chartPI=null; return; }
  panelNo.classList.add('hide');
  const g = {};
  for (const x of r.items){
    if (String(x.type)!=='repay') continue;
    const ym = String(x.date||'').slice(0,7);
    if (!g[ym]) g[ym] = { prin:0, intr:0 };
    g[ym].prin += Number(x.principal_paid||0);
    g[ym].intr += Number(x.interest_paid||0);
  }
  const labels = Object.keys(g).sort();
  if (!labels.length){ panelNo.classList.remove('hide'); chartPI=null; return; }
  const prin = labels.map(m=> g[m].prin);
  const intr = labels.map(m=> g[m].intr);
  chartPI = new Chart($('#chartPI'), {
    type:'line',
    data:{ labels,
      datasets:[
        { label:'‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)', data:prin, borderColor:'#00c896', backgroundColor:'rgba(0,200,150,.15)', tension:.35, fill:false },
        { label:'‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)', data:intr, borderColor:'#ffb020', backgroundColor:'rgba(255,176,32,.15)', tension:.35, fill:false },
      ] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}}
  });
}

/* ===== Small utils ===== */
function dateRangeArray(from, to){
  const out = []; const df = new Date(from), dt = new Date(to);
  if (isNaN(df)||isNaN(dt) || df>dt) return out;
  for (let d=new Date(df); d<=dt; d=new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)){ out.push(toYMD(d)); }
  return out;
}

/* ===== INIT ===== */
function init(){
  setType('expense'); ensureLoginUI();
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') { closeEdit(); closeDebtEdit(); } });
  renderQAs();
}
init();

/* ===== [ADD-ON] Quick Add: category picker (‡πÄ‡∏î‡∏¥‡∏°) ===== */
(function setupQACategoryUI(){
  const row = document.querySelector('#tab-add .quickadd .row');
  if (!row) return;
  const col = document.createElement('div');
  col.className = 'col';
  col.innerHTML = `<select id="qaCat"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</option></select>`;
  row.insertBefore(col, row.lastElementChild);
  const typeSel = document.getElementById('qaType');
  typeSel?.addEventListener('change', populateQACat);
  populateQACat();
})();
function populateQACat(){
  const sel = document.getElementById('qaCat');
  const typeSel = document.getElementById('qaType');
  if (!sel || !typeSel) return;

  const t = typeSel.value || 'expense';
  const list = (typeof cats !== 'undefined' && cats[t]) ? cats[t] : [];

  sel.innerHTML = `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</option>`;

  // ‡∏Å‡∏£‡∏≠‡∏á ‚Äú‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ/‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Quick Add ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
  list
    .filter(c => !_isDebtFlowCat(c))
    .forEach(c => {
      const o = document.createElement('option');
      o.value = c.category_id;
      o.textContent = c.name_th;
      sel.appendChild(o);
    });
}
function _findCat(type, category_id){ const list = (typeof cats !== 'undefined' && cats[type]) ? cats[type] : []; return list.find(c => String(c.category_id) === String(category_id)) || null; }
(function(){
  const _addQA_prev = typeof addQA === 'function' ? addQA : null;
  window.addQA = function(label, type, amount){
    if (!document.getElementById('qaCat')?.options?.length) populateQACat();
    const catId = (document.getElementById('qaCat')?.value || '').trim();
    const list = (function(){ try{ return JSON.parse(localStorage.getItem('fin_quick_add')||'[]'); }catch{return [];} })();
    const amt = Number(amount);
    if (!label || !isFinite(amt) || amt<=0){ toast('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á Quick Add ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
    let catName = ''; if (catId){ const obj = _findCat(type, catId); catName = obj ? (obj.name_th || '') : ''; }
    list.unshift({ id: Date.now(), label, type, amount: Math.round(amt*100)/100, category_id: catId || undefined, category_name: catName || undefined });
    localStorage.setItem('fin_quick_add', JSON.stringify(list.slice(0,12)));
    if (typeof renderQAs === 'function') renderQAs();
    const l = document.getElementById('qaLabel'); if (l) l.value=''; const a = document.getElementById('qaAmount'); if (a) a.value='';
  };
  window.quickAddCommit = async function(q){
    let category_id = q && q.category_id ? q.category_id : '';
    const t = q?.type || 'expense';
    if (!category_id){
      const sel = document.getElementById('qaCat');
      if (sel && document.getElementById('qaType')?.value === t && sel.value) category_id = sel.value;
    }
    if (!category_id){
      const arr = (typeof cats !== 'undefined' && cats[t]) ? cats[t] : [];
      if (!arr.length){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ', false); return; }
      category_id = arr[0].category_id;
    }
    const payload = { date: (typeof todayISO === 'function') ? todayISO() : (new Date().toISOString().slice(0,10)), type: t, category_id, amount: q?.amount, note: q?.label };
    try{
      const r = await api('transactions/create', payload, true, true);
      if (r.ok){ popSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); if (typeof refreshDash==='function') refreshDash(true); }
      else toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
    }catch(e){ toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); }
  };
})();
(function decorateQAChips(){
  const _render_prev = typeof renderQAs === 'function' ? renderQAs : null;
  window.renderQAs = function(){
    if (_render_prev) _render_prev();
    const wrap = document.getElementById('quickWrap'); if (!wrap) return;
    const list = (function(){ try{ return JSON.parse(localStorage.getItem('fin_quick_add')||'[]'); }catch{return [];} })();
    const chips = Array.from(wrap.querySelectorAll('.qa'));
    chips.forEach((chip, idx)=>{
      const q = list[idx]; if (!q) return;
      const name = q.category_name || (q.category_id ? (_findCat(q.type, q.category_id)?.name_th || '') : '');
      if (name && !chip.dataset.decorated){
        chip.textContent = `${q.label} ‚Ä¢ ${name}`;
        const x = document.createElement('span'); x.className='x'; x.textContent='√ó';
        x.addEventListener('click', (e)=>{ e.stopPropagation();
          const next = list.filter(x=>x.id!==q.id);
          localStorage.setItem('fin_quick_add', JSON.stringify(next));
          if (typeof renderQAs==='function') renderQAs();
          toast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        });
        chip.appendChild(x);
        chip.dataset.decorated = '1';
      }
    });
  };
})();
</script>
</body>
</html>
